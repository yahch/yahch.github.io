<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Android应用里的Webview控件嵌入 - ORIGAE,Tinypress">
    <meta name="description" content="Android应用里的Webview控件嵌入,Tinypress" />
    <title>Android应用里的Webview控件嵌入 - ORIGAE</title>
    <link href="/styles/main.css" rel="stylesheet" />
</head>
<body>
    <header class="head">
        <h1 class="head-title u-fl"><a href="/">ORIGAE</a></h1>
        <nav class="head-nav u-fr">
            <ul class="head-nav__list">
                
            </ul>
        </nav>
    </header>
    <main class="main"><article class="post">
    <header class="post__head">
        <h1 class="post__title"><a href="/post/22">Android应用里的Webview控件嵌入</a></h1>
        <p datetime="5/28/2018 11:09:24 PM" class="post__time">5/28/2018 11:09:24 PM</p>
    </header>
    <div class="post__main echo">
        <p>借之前的文章开发一个新的组件，用于在 app 内愉快的使用 webview。</p>
<p>比如在微信里，打开微信公众号文章的时候，这里文章的内容的渲染都是由 webview 控件完成的，这比在浏览器里打开友善多了，并且功能更强大，可以调用外部程序，识别二维码，支付等等。假如我们的 app 里有动态内容，会经常在服务端编辑好页面的方式更新，那么使用 webview 展示是最好不过了。</p>
<p>之前的那篇文章中提到过，可以动态传递对象到含有 webview 的 activity 页面，因为这个 activity 每次只会打开一个实例，为了简化对象的传递，用的是单例存储要传递的对象，代码参考如下：</p>
<pre><code>public enum WebFrameSettings {
    instance;

    private String url;
    private HashMap&lt;String, Object&gt; objs;

    public String getUrl() {
        return url;
    }

    public void setUrl(String url) {
        this.url = url;
    }

    public HashMap&lt;String, Object&gt; getObjs() {
        return objs;
    }

    public void addObject(String key, Object val) {
        objs.put(key, val);
    }

    public void clearObjects() {
        objs.clear();
    }

    public void removeObject(String key) {
        objs.remove(key);
    }

    WebFrameSettings() {
        url = &quot;&quot;;
        objs = new HashMap&lt;&gt;();
    }

}
</code></pre>
<p>接下来创建一个 activity，放置 Toolbar 、ProgressBar、WebView 控件。</p>
<p><img src="/images/2018_5_636631457955734550.png" alt="" /></p>
<p>界面布局代码如下：</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;LinearLayout
    xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;
    xmlns:tools=&quot;http://schemas.android.com/tools&quot;
    android:layout_width=&quot;match_parent&quot;
    android:layout_height=&quot;match_parent&quot;
    android:orientation=&quot;vertical&quot;
    tools:context=&quot;me.xuzhi.webframemodule.WebFrameActivity&quot;&gt;


    &lt;android.support.v7.widget.Toolbar
        android:id=&quot;@+id/toolbarWebFrameModule&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;wrap_content&quot;
        android:layout_alignParentStart=&quot;true&quot;
        android:layout_alignParentTop=&quot;true&quot;
        android:background=&quot;@color/webFrameToolbarBackgroundColor&quot;
        android:titleTextColor=&quot;@color/webFrameToolbarForcegroundColor&quot;
        app:titleTextColor=&quot;@color/webFrameToolbarForcegroundColor&quot;&gt;

    &lt;/android.support.v7.widget.Toolbar&gt;

    &lt;FrameLayout
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;match_parent&quot;
        android:layout_alignParentStart=&quot;true&quot;&gt;

        &lt;WebView
            android:id=&quot;@+id/webViewWebFrameModule&quot;
            android:layout_width=&quot;match_parent&quot;
            android:layout_height=&quot;match_parent&quot;
            android:layout_below=&quot;@+id/progressBar&quot;/&gt;

        &lt;ProgressBar
            android:id=&quot;@+id/progressBarWebFrameModule&quot;
            style=&quot;?android:attr/progressBarStyleHorizontal&quot;
            android:layout_width=&quot;match_parent&quot;
            android:layout_height=&quot;2dp&quot;
            android:progress=&quot;50&quot;
            android:progressDrawable=&quot;@drawable/progress_bar_webframe&quot;/&gt;

    &lt;/FrameLayout&gt;

&lt;/LinearLayout&gt;

</code></pre>
<p>为这个模块创建一个主题，否则 Toolbar 右上角的三个点都是黑色的。</p>
<pre><code>&lt;resources&gt;
    &lt;style name=&quot;ModuleTheme&quot; parent=&quot;Theme.AppCompat.Light.NoActionBar&quot;&gt;
        &lt;item name=&quot;android:textColorSecondary&quot;&gt;#ffffff&lt;/item&gt;
    &lt;/style&gt;
&lt;/resources&gt;
</code></pre>
<p>为 Toolbar 设置标题和返回图标。</p>
<pre><code>toolbarWebFrameModule.setTitle(WebFrameSettings.instance.getUrl());
toolbarWebFrameModule.setNavigationIcon(R.drawable.ic_action_arrow_back);
</code></pre>
<p>注意 setNavigationOnClickListener 一定要在 setSupportActionBar 之后调用，否则不生效。</p>
<pre><code>setSupportActionBar(toolbarWebFrameModule);
toolbarWebFrameModule.setNavigationOnClickListener(new View.OnClickListener() {
    @Override
    public void onClick(View v) {
        if (webViewWebFrameModule.canGoBack()) {
            webViewWebFrameModule.goBack();
        } else finish();
    }
});
</code></pre>
<p>为 Toolbar 增加菜单。</p>
<pre><code>&lt;menu xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
      xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;
      xmlns:tools=&quot;http://schemas.android.com/tools&quot;
      tools:context=&quot;.MainActivity&quot;&gt;
    &lt;item
        android:id=&quot;@+id/action_close&quot;
        android:icon=&quot;@drawable/ic_action_close&quot;
        android:title=&quot;关闭&quot;
        app:showAsAction=&quot;always&quot;/&gt;
    &lt;item
        android:id=&quot;@+id/action_refresh&quot;
        android:title=&quot;刷新&quot;
        app:showAsAction=&quot;collapseActionView&quot;/&gt;
    &lt;item
        android:id=&quot;@+id/action_share&quot;
        android:title=&quot;分享&quot;
        app:showAsAction=&quot;collapseActionView&quot;/&gt;
    &lt;item
        android:id=&quot;@+id/action_copylink&quot;
        android:title=&quot;复制链接&quot;
        app:showAsAction=&quot;collapseActionView&quot;/&gt;
    &lt;item
        android:id=&quot;@+id/action_openWithBrowser&quot;
        android:title=&quot;在浏览器中打开&quot;
        app:showAsAction=&quot;collapseActionView&quot;/&gt;
&lt;/menu&gt;
</code></pre>
<p>重写 activity 的 onCreateOptionsMenu 方法，将 menu 添加进来。</p>
<pre><code>@Override
public boolean onCreateOptionsMenu(Menu menu) {
    getMenuInflater().inflate(R.menu.menu_webframe, menu);
    return true;
}
</code></pre>
<p>菜单按钮的事件：</p>
<pre><code>@Override
public boolean onOptionsItemSelected(MenuItem item) {
    int id = item.getItemId();
    if (id == R.id.action_close) {
        finish();
    } else if (id == R.id.action_copylink) {
        doCopyLink();
    } else if (id == R.id.action_openWithBrowser) {
        doOpenWithBrowser();
    } else if (id == R.id.action_refresh) {
        doRefresh();
    } else if (id == R.id.action_share) {
        doShare();
    }
    return true;
}
</code></pre>
<p>关于复制的问题，ClipboardManager 的 setText 方法已经过时了，应该换用 setPrimaryClip 方法。</p>
<pre><code>private void doCopyLink() {
    try {
        ClipboardManager cm = (ClipboardManager) getSystemService(Context.CLIPBOARD_SERVICE);
        ClipData clipData = ClipData.newPlainText(&quot;link&quot;, WebFrameSettings.instance.getUrl());
        cm.setPrimaryClip(clipData);
        Toast.makeText(getApplicationContext(), &quot;复制链接成功&quot;, Toast.LENGTH_SHORT).show();
    } catch (Exception ex) {
        Toast.makeText(getApplicationContext(), &quot;复制链接失败&quot;, Toast.LENGTH_SHORT).show();
    }
}
</code></pre>
<p>如果 webview 中需要 js 调用 java 方法，可以在单例添加对应的类，webview 在执行 loadUrl 之前会检查是否有对象值。</p>
<pre><code>HashMap&lt;String, Object&gt; invokeObjects = WebFrameSettings.instance.getObjs();
if (invokeObjects.size() &gt; 0) {
    Iterator iter = invokeObjects.entrySet().iterator();
    while (iter.hasNext()) {
        Map.Entry entry = (Map.Entry) iter.next();
        String key = entry.getKey().toString();
        Object val = entry.getValue();
        webViewWebFrameModule.addJavascriptInterface(val, key);
    }
}
</code></pre>
<p>webview 的 onProgressChanged 和 onPageFinished 比较让人头疼，因为加载某个资源出错也会触发，所以只凭两个方法判断页面加载完成还是不科学，这就导致加载进度条的什么时候结束很让人纠结。</p>
<p>整体效果：</p>
<p><img src="/images/2018_5_636631458143976170.gif" alt="" /></p>
<p>这个模块我已放到 github 上，戳 https://github.com/yahch/WebFrame</p>
<p>也可以直接在项目引用：</p>
<pre><code>allprojects {
		repositories {
			...
			maven { url 'https://jitpack.io' }
		}
}
</code></pre>
<pre><code>dependencies {
	        compile 'com.github.yahch:WebFrame:1.1'
 }
</code></pre>
<pre><code>Intent intent = new Intent(MainActivity.this, WebFrameActivity.class);
WebFrameSettings.instance.setUrl(&quot;http://weibo.cn&quot;);
startActivity(intent);
</code></pre>

    </div>
</article></main>
    <footer class="foot">
        <div class="foot-copy u-fl">© 2018 ORIGAE&nbsp;&nbsp;|&nbsp;&nbsp; POWERED BY TiNYFX</div>
        <menu class="page-menu u-fr">
            
            
        </menu>
    </footer>
</body>
</html>
